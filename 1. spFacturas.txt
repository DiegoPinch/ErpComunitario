USE water_system;
DELIMITER //

DROP PROCEDURE IF EXISTS sp_record_reading_and_invoice//

CREATE PROCEDURE sp_record_reading_and_invoice(
    IN p_user_id INT,
    IN p_meter_id INT,
    IN p_billing_month VARCHAR(7),
    IN p_current_reading INT
)
BEGIN
    DECLARE v_prev_reading INT;
    DECLARE v_invoice_id INT;
    DECLARE v_meter_type VARCHAR(20);
    DECLARE v_rate_id INT;
    DECLARE v_unit_price DECIMAL(10,2);
    DECLARE v_base_limit INT;
    DECLARE v_excess_price DECIMAL(10,2);
    DECLARE v_consumption INT;
    DECLARE v_excess INT;
    DECLARE v_amount DECIMAL(10,2);
    DECLARE v_existing_reading_id INT;
    DECLARE v_old_amount DECIMAL(10,2) DEFAULT 0;
    DECLARE v_invoice_status VARCHAR(20) DEFAULT 'pending';

    -- 1. Verificar si ya existe lectura
    SELECT reading_id, amount
    INTO v_existing_reading_id, v_old_amount
    FROM readings
    WHERE meter_id = p_meter_id
      AND month_year = p_billing_month
    LIMIT 1;

    -- 2. Buscar factura
    SELECT invoice_id, status
    INTO v_invoice_id, v_invoice_status
    FROM invoices
    WHERE user_id = p_user_id
      AND billing_month = p_billing_month
    LIMIT 1;

    -- 3. Seguridad: factura pagada
    IF v_invoice_id IS NOT NULL AND v_invoice_status = 'paid' THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'No se puede modificar una lectura con factura pagada';
    END IF;

    -- 4. Tipo de medidor
    SELECT type INTO v_meter_type
    FROM meters
    WHERE meter_id = p_meter_id;

    -- 5. Lectura anterior
    SELECT current_reading
    INTO v_prev_reading
    FROM readings
    WHERE meter_id = p_meter_id
      AND month_year < p_billing_month
    ORDER BY month_year DESC
    LIMIT 1;

    IF v_prev_reading IS NULL THEN
        SELECT initial_reading
        INTO v_prev_reading
        FROM meters
        WHERE meter_id = p_meter_id;
    END IF;

    -- 6. Tarifa activa
    SELECT rate_id, unit_price, base_limit, excess_price
    INTO v_rate_id, v_unit_price, v_base_limit, v_excess_price
    FROM rates
    WHERE meter_type = v_meter_type
      AND active = TRUE
    LIMIT 1;

    -- 7. CÃ¡lculos
    SET v_consumption = p_current_reading - v_prev_reading;

    IF v_consumption < 0 THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'La lectura actual no puede ser menor a la anterior';
    END IF;

    SET v_excess = GREATEST(0, v_consumption - v_base_limit);
    SET v_amount = v_unit_price + (v_excess * v_excess_price);

    -- 8. Crear factura si no existe
    IF v_invoice_id IS NULL THEN
        INSERT INTO invoices (user_id, billing_month, total_amount, issue_date, status)
        VALUES (p_user_id, p_billing_month, v_amount, CURRENT_DATE, 'pending');

        SET v_invoice_id = LAST_INSERT_ID();
    END IF;

    -- 9. Insertar o actualizar lectura
    IF v_existing_reading_id IS NULL THEN
        INSERT INTO readings (
            invoice_id, meter_id, rate_id, month_year,
            previous_reading, current_reading, consumption, excess, amount
        )
        VALUES (
            v_invoice_id, p_meter_id, v_rate_id, p_billing_month,
            v_prev_reading, p_current_reading, v_consumption, v_excess, v_amount
        );
    ELSE
        UPDATE readings
        SET
            rate_id = v_rate_id,
            previous_reading = v_prev_reading,
            current_reading = p_current_reading,
            consumption = v_consumption,
            excess = v_excess,
            amount = v_amount
        WHERE reading_id = v_existing_reading_id;
    END IF;

    -- 10. Recalcular factura
    CALL sp_update_invoice_total(v_invoice_id);

    -- Resultado
    SELECT
        v_amount AS reading_amount,
        total_amount AS invoice_total
    FROM invoices
    WHERE invoice_id = v_invoice_id;
END//

DELIMITER ;
